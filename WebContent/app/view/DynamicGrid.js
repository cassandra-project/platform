/*
 * File: app/view/DynamicGrid.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('C.view.DynamicGrid', {
	extend: 'Ext.grid.Panel',

	minHeight: 250,
	padding: 5,
	autoScroll: true,
	title: 'My Grid Panel',
	columnLines: false,
	forceFit: true,
	store: 'Scenarios',

	initComponent: function() {
		var me = this;

		Ext.applyIf(me, {
			viewConfig: {
				overflowX: 'auto',
				overflowY: 'auto',
				loadingText: 'loading..',
				plugins: [
					Ext.create('Ext.grid.plugin.DragDrop', {
						ddGroup: 'ddGlobal'
					})
				],
				listeners: {
					beforedrop: {
						fn: me.onGriddragdroppluginBeforeDrop,
						scope: me
					}
				}
			},
			columns: [
				{
					xtype: 'gridcolumn',
					dataIndex: '_id',
					text: '_id'
				}
			],
			selModel: Ext.create('Ext.selection.RowModel', {
				mode: 'MULTI'
			}),
			dockedItems: [
				{
					xtype: 'toolbar',
					dock: 'top',
					width: 508,
					items: [
						{
							xtype: 'button',
							text: 'New',
							listeners: {
								click: {
									fn: me.onButtonClick,
									scope: me
								},
								beforerender: {
									fn: me.onButtonBeforeRender,
									scope: me
								}
							}
						},
						{
							xtype: 'button',
							text: 'Delete',
							listeners: {
								click: {
									fn: me.onButtonClick1,
									scope: me
								}
							}
						},
						{
							xtype: 'button',
							text: 'Edit',
							listeners: {
								click: {
									fn: me.onButtonClick11,
									scope: me
								},
								beforerender: {
									fn: me.onButtonBeforeRender1,
									scope: me
								}
							}
						},
						{
							xtype: 'button',
							hidden: true,
							text: 'Compare',
							listeners: {
								click: {
									fn: me.onButtonClick111,
									scope: me
								},
								beforerender: {
									fn: me.onButtonBeforeRender2,
									scope: me
								}
							}
						},
						{
							xtype: 'button',
							hidden: true,
							text: 'Upload file',
							listeners: {
								click: {
									fn: me.onButtonClick1111,
									scope: me
								},
								beforerender: {
									fn: me.onButtonBeforeRender21,
									scope: me
								}
							}
						}
					]
				}
			],
			listeners: {
				itemdblclick: {
					fn: me.onGridpanelItemDblClick,
					scope: me
				},
				beforerender: {
					fn: me.onGridpanelBeforeRender,
					scope: me
				},
				afterrender: {
					fn: me.onGridpanelAfterRender,
					scope: me
				}
			},
			tools: [
				{
					xtype: 'tool',
					type: 'unpin',
					listeners: {
						click: {
							fn: me.onToolClick1,
							scope: me
						}
					}
				},
				{
					xtype: 'tool',
					tooltip: 'Refresh view',
					type: 'refresh',
					listeners: {
						click: {
							fn: me.onToolClick,
							scope: me
						}
					}
				}
			],
			plugins: [
				Ext.create('Ext.grid.plugin.BufferedRenderer', {

				})
			]
		});

		me.callParent(arguments);
	},

	onGriddragdroppluginBeforeDrop: function(node, data, overModel, dropPosition, dropHandlers, eOpts) {
		console.info('Before drop.', this, node, data, overModel, dropPosition, dropHandlers, eOpts);
		/* NOTE
		Returning false to this event signals that the drop gesture was invalid, and if the drag proxy will
		animate back to the point from which the drag began.
		Returning 0 To this event signals that the data transfer operation should not take place, but that
		the gesture was valid, and that the repair operation should not take place.
		*/
		var record = (data.records[0].node) ? data.records[0].node : data.records[0];

		if('C.model.'+record.get('nodeType')==this.store.model.modelName){
			dropHandlers.cancelDrop();
			var index = Ext.getStore(record.get('nodeStoreId')).findExact('_id',record.get('id'));
			var node = Ext.getStore(record.get('nodeStoreId')).getAt(index);
			var parent_id = (this.store.navigationNode.get('nodeType') == 'ProjectsCollection')?'':this.store.navigationNode.parentNode.get('id');
			parent_idKey = '';
			switch(record.get('nodeType')){
				case 'Scenario': parent_idKey = 'project_id'; break;
				case 'SimulationParam': parent_idKey = 'scn_id'; break;
				case 'Installation': parent_idKey = 'scenario_id'; break;
				case 'Pricing': parent_idKey = 'scn_id'; break;
				case 'Demographic': parent_idKey = 'scn_id'; break;
				case 'Person': parent_idKey = 'inst_id'; break;
				case 'Appliance': parent_idKey = 'inst_id'; break;
				case 'Activity': parent_idKey = 'pers_id'; break;
				case 'ActivityModel': parent_idKey = 'act_id'; break;
				default: return false;
			}

			if ( !Ext.EventObject.shiftKey && record.get('nodeType') !== 'Pricing' && record.get('nodeType') !== 'Demographic' && record.get('nodeType') !== 'SimulationParam'){
				data.copy = true;
				var targetID = '';
				var meID = '';
				switch(record.get('nodeType')){
					case 'Scenario': targetID = 'toPrjID'; meID = 'scnID'; parent_idKey = 'prj_id'; break;
					case 'Installation': targetID = 'toScnID'; meID = 'instID'; parent_idKey = 'scn_id'; break;
					case 'Person': targetID = 'toInstID'; meID = 'persID'; break;
					case 'Appliance': targetID = 'toInstID'; meID = 'appID'; break;
					case 'Activity': targetID = 'toPersID'; meID = 'actID'; break;
					case 'ActivityModel': targetID = 'toActID'; meID = 'actmodID'; break;

					default: return false;
				}

				Ext.Ajax.request({
					url: '/cassandra/api/copy?'+meID+'='+node.get('_id')+'&'+targetID+'='+parent_id,
					method: 'POST',
					scope: this,
					success: function(response, eOpts) {	
						response = JSON.parse(response.responseText);
						var params = {};
						params[parent_idKey] = parent_id;
						this.store.navigationNode.removeAll();
						this.store.load( {params : params });
						Ext.sliding_box.msg('Success', JSON.stringify(response.message));
					}
				});

			} 
			else {

				//Ext.sliding_box.msg('Drag and Drop info', 'By holding <b>Shift</b> key pressed while copying a node </br> all its childred will be copied as well');

				var dataToAdd = JSON.parse(JSON.stringify(node.data));
				delete dataToAdd._id;
				dataToAdd[parent_idKey] = parent_id;
				this.store.add(dataToAdd);

			}
			return 0;
		}
		return false;
	},

	onButtonClick: function(button, e, eOpts) {
		console.info('Add clicked.', this, button, e, eOpts);

		var parent_id = (this.store.navigationNode.get('nodeType') == 'ProjectsCollection')?'':this.store.navigationNode.parentNode.get('id');
		var inputArray = {};
		switch(this.store.navigationNode.get('nodeType')){
			case 'ProjectsCollection': inputArray = {};break;
			case 'ScenariosCollection': inputArray = {'project_id' : parent_id};break;
			case 'InstallationsCollection': inputArray = {'scenario_id' : parent_id}; break;
			case 'PricingSchemesCollection': inputArray = {'scn_id' : parent_id}; break;
			case 'DemographicsCollection': inputArray = {'scn_id' : parent_id}; break;
			case 'SimulationParamsCollection': 
			var calendar = C.app.getCalendar( new Date());
			inputArray = {'scn_id' : parent_id, calendar: calendar}; 
			break;
			case 'PersonsCollection': inputArray = {'inst_id' : parent_id}; break;
			case 'AppliancesCollection': inputArray = {'inst_id': parent_id}; break;
			case 'ActivitiesCollection': inputArray = {'pers_id': parent_id}; break;
			case 'ActivityModelsCollection': inputArray = {'act_id' : parent_id}; break;
			default: return false;
		}
		var currentModel = this.store.getProxy().getModel();
		var cur_record = new currentModel(inputArray);


		this.store.insert(0, cur_record);


		/*this.store.on('update', function(abstractstore, records, operation) {
		if (operation == 'commit') {
		var record = this.getAt(0);
		C.app.createForm(record.node);
		}
		});
		*/

		//this.plugins[0].startEdit(0, 0);




	},

	onButtonBeforeRender: function(component, eOpts) {
		if (this.store.model.getName() == "C.model.Run")
		component.hide();
	},

	onButtonClick1: function(button, e, eOpts) {
		console.info('Delete clicked.', this, button, e, eOpts);

		var tabs = Ext.getCmp('MainTabPanel');
		var selections = this.getView().getSelectionModel().getSelection();

		if (selections) {

			//check if there are open tabs with selections and if yes, close them
			Ext.each(selections, function(selection, index) {
				var node = selection.node;
				var pathToMe =  node.get('nodeType')+':'+node.getPath();
				Ext.each (tabs.items.items, function(item, index) {
					if (item.pathToMe == pathToMe) {
						item.close();
						return false;
					}
				});
			});

			this.store.remove(selections);
		}
	},

	onButtonClick11: function(button, e, eOpts) {
		console.info('Edit clicked.', this, button, e, eOpts);

		var selections = this.getView().getSelectionModel().getSelection();
		if (selections) {
			Ext.each(selections, function(index){
				C.app.createForm(index.node);
			});
		}
	},

	onButtonBeforeRender1: function(component, eOpts) {
		if (this.store.model.getName() == "C.model.Run")
		component.hide();
	},

	onButtonClick111: function(button, e, eOpts) {
		console.info('cOMPARE clicked.', this, button, e, eOpts);

		var exception = false;
		var selections = this.getView().getSelectionModel().getSelection();
		if (selections.length < 2) {
			Ext.MessageBox.show({title:'Error', msg: 'You need to choose 2 or more runs to compare', icon: Ext.MessageBox.ERROR, buttons: Ext.MessageBox.OK});
			return false;
		}


		Ext.each(selections, function(selection, index) {
			if (  selection.get('percentage') !== 100  ) {
				Ext.MessageBox.show({title:'Error', msg: 'Please choose 2 or more successfully completed runs', icon: Ext.MessageBox.ERROR, buttons: Ext.MessageBox.OK});
				exception = true;
				return false;
			}
		});
		if (exception)
		return false;

		var chartWindow = new Ext.Window({
			title  : 'Compare runs and KPIs',
			width : 850,
			height : 650,
			bodyPadding: 20,
			autoScroll : true
		}); 

		chartWindow.show();
		chartWindow.setLoading(true, true);

		var fields = 
		[{
			name: 'x',
			type: 'float'
		}];
		var yFieldArray = [];
		var dataArray = [];
		var recordArray = [];
		var series = [];

		Ext.each(selections, function(selection, index) {
			var sel_id = selection.get('_id');
			fields.push(
			{
				name: 'y'+index,
				mapping: 'y',
				type: 'float'
			}
			);
			yFieldArray.push('y'+index);

			var tempStore = new C.store.Results({});
			tempStore.proxy.headers = {'dbname': sel_id};

			var kpiStore = new C.store.Kpis();
			kpiStore.proxy.headers = {'dbname': sel_id};

			series.push({
				title: selection.get('name'),
				type: 'line',
				highlight: {
					size: 4,
					radius: 4
				},
				tips: {
					trackMouse: true,
					width: 180,
					height: 70,
					renderer: function(storeItem, item) {
						this.setTitle( selection.get('name') + '</br>' + 'Watt : ' + storeItem.get('y'+index) + '<br />' +  'Time : ' + storeItem.get('x'));
					}
				},
				xField: 'x',
				yField: [
				'y'+index
				],
				selectionTolerance: 6,
				showMarkers: false,
				smooth: 3

			});


			tempStore.on('load',function(store, records){

				if (dataArray.length === 0)
				Ext.each(store.data.items, function(item,inner_index) {
					dataArray.push({'x':item.get('x'), 'y0':item.get('y')});
				});
				else {
					var index =Object.keys(dataArray[0]).length - 1;
					Ext.each(store.data.items, function(item,inner_index) {
						dataArray[inner_index]['y'+ index] = item.get('y');
					});
				}
				//check if dataArray is filled with all data
				if (dataArray[0].hasOwnProperty(['y' + (selections.length - 1)])) {

					var mystore = Ext.create('Ext.data.Store', {
						fields: fields
						//data: dataArray
					});
					mystore.loadData(dataArray);

					var myResultsChart = Ext.create('Ext.chart.Chart', {
						renderTo: Ext.getBody(),
						width: 800, 
						height: 600, 
						legend: {position: 'bottom'},
						store: mystore,
						axes: [
						{
							type: 'Numeric',
							fields: [
							'x'
							],
							majorTickSteps: 20,
							minorTickSteps: 5,
							position: 'bottom',
							title: 'Time'
						},
						{
							type: 'Numeric',
							fields: yFieldArray,
							grid: {
								odd: {
									opacity: 1,
									fill: '#ddd',
									stroke: '#bbb',
									'stroke-width': 0.5
								}
							},
							position: 'left',
							title: 'Watt'
						}
						],
						series: series

					});

					chartWindow.insert(0, myResultsChart);
					chartWindow.setLoading(false);
				}
			});
			tempStore.load();

			kpiStore.on('load',function(store, records){

				records[0].data.name = selection.get('name');
				recordArray.push(records[0]);

				if (recordArray.length == selections.length) {
					var myKpiStore = Ext.create('Ext.data.Store', {
						model: 'C.model.Kpi'
						//data: dataArray
					});
					myKpiStore.loadRecords(recordArray);
					var grid = Ext.getCmp('uiNavigationTreePanel').getCustomGrid(myKpiStore);
					grid.width = 800;
					grid.closable = false;
					grid.setTitle("KPIs");
					grid.query("tool")[0].hide();
					chartWindow.insert(1, grid);
				}
			});
			kpiStore.load();
		});






		/*Ext.each(selections, function(selection, index) {

		var sel_id = selection.get('_id');
		var compPanel = new C.view.ComparePanel({title : 'Total Consumption Active Power for run: ' + selection.get('_id')});

		myResultsStore = new C.store.Results();
		myResultsStore.proxy.headers = {'dbname': sel_id};
		myResultsChart = new C.view.ResultsLineChart({width: 400, height: 300, store: myResultsStore});
		var myMask = new Ext.LoadMask(myResultsChart, { msg: 'Please wait...', store: myResultsStore});
		myResultsStore.load();
		compPanel.add(myResultsChart);

		var kpiStore = new C.store.Kpis();
		kpiStore.proxy.headers = {'dbname': sel_id};
		kpiStore.load();
		var grid = Ext.getCmp('uiNavigationTreePanel').getCustomGrid(kpiStore);
		grid.width = 400;
		grid.closable = false;
		grid.setTitle("KPIs");
		grid.query("tool")[0].hide();
		compPanel.add(grid);

		chartWindow.add(compPanel);
		});


		chartWindow.show();*/

	},

	onButtonBeforeRender2: function(component, eOpts) {
		if (this.store.model.getName() == "C.model.Run")
		component.show();
	},

	onButtonClick1111: function(button, e, eOpts) {

		var formWindow = new Ext.Window({
			items  : new C.view.FileUploadForm(),
			title  : 'Upload file'
		}); 
		formWindow.show();
	},

	onButtonBeforeRender21: function(component, eOpts) {
		if (this.store.model.getName() == "C.model.Run")
		component.show();
	},

	onGridpanelItemDblClick: function(dataview, record, item, index, e, eOpts) {
		if (record.node)
		C.app.createForm(record.node);
	},

	onToolClick1: function(tool, e, eOpts) {

		var gridWindow = new Ext.Window({
			title : this.header.title,
			items : this,
			layout: 'fit',
			tools: [
			{
				xtype: 'tool',
				type: 'pin',
				listeners: {
					'click': 
					function(tool, e, eOpts) {
						var gridWindow = this.getBubbleParent().getBubbleParent();
						var gridPanel = gridWindow.query("grid")[0];
						var tabPanel = Ext.getCmp('MainTabPanel');
						tabPanel.add(gridPanel);
						tabPanel.setActiveTab(gridPanel);
						tabPanel.getActiveTab().header.show();

						gridWindow.close();

					}	
				}
			}
			]
		}); 
		gridWindow.show();
		if (this.hidden) this.show();
		this.header.hide();

		/*tool.hide();
		this.query("tool")[1].show();*/



		/*
		var gridWindow = new Ext.Window({
		items : this

		}); 
		gridWindow.show();
		tool.hide();
		this.query("tool")[1].show();
		*/
	},

	onToolClick: function(tool, e, eOpts) {
		var node = this.store.navigationNode;
		var parent_id = (node.get('nodeType') == 'ProjectsCollection')?'':node.parentNode.get('id');
		var params = {};
		switch(node.get('nodeType')){
			case 'ProjectsCollection': params = {};break;
			case 'ScenariosCollection': params = {'prj_id' : parent_id};break;
			case 'InstallationsCollection': params = {'scn_id' : parent_id}; break;
			case 'PricingSchemesCollection': params = {'scn_id' : parent_id}; break;
			case 'DemographicsCollection': params = {'scn_id' : parent_id}; break;
			case 'SimulationParamsCollection': params = {'scn_id' : parent_id}; break;
			case 'PersonsCollection': params = {'inst_id' : parent_id}; break;
			case 'AppliancesCollection': params = {'inst_id': parent_id}; break;
			case 'ActivitiesCollection': params = {'pers_id': parent_id}; break;
			case 'ActivityModelsCollection': params = {'act_id' : parent_id}; break;
			case 'RunsCollection': params = {'prj_id' : parent_id}; break;
			default: return false;
		}
		while (node.hasChildNodes()) {
			node.removeChild(node.childNodes[0]);
		}
		this.store.load({params: params});
	},

	onGridpanelBeforeRender: function(component, eOpts) {
		//console.info(component);
		if (!component.tab) {
			component.setHeight(250);
			component.setWidth(750);
			//component.maxHeight = 250;
			component.margin = '0 0 10px 0';
			component.tools[0].hidden = true;
		}
		if (component.store.model.getName() == "C.model.Kpi")
		component.down('toolbar').hide();
	},

	onGridpanelAfterRender: function(component, eOpts) {
		return false;
		var node = component.store.navigationNode;
		if (!node)
		return false;
		//apply only to installations for now
		if (node.get('nodeType') !== 'InstallationsCollection')
		return false;

		var parent_id = (node.get('nodeType') == 'ProjectsCollection')?'':node.parentNode.get('id');
		var inputArray = {};
		switch(node.get('nodeType')){
			case 'ProjectsCollection': inputArray = {};break;
			case 'ScenariosCollection': inputArray = {'prj_id' : parent_id};break;
			case 'InstallationsCollection': inputArray = {'scn_id' : parent_id}; break;
			case 'PricingSchemesCollection': inputArray = {'scn_id' : parent_id}; break;
			case 'DemographicsCollection': inputArray = {'scn_id' : parent_id}; break;
			case 'SimulationParamsCollection': inputArray = {'scn_id' : parent_id}; break;
			case 'PersonsCollection': inputArray = {'inst_id' : parent_id}; break;
			case 'AppliancesCollection': inputArray = {'inst_id': parent_id}; break;
			case 'ActivitiesCollection': inputArray = {'pers_id': parent_id}; break;
			case 'ActivityModelsCollection': inputArray = {'act_id' : parent_id}; break;
			default: return false;
		}



		var myToolbar = new Ext.toolbar.Paging( {
			store : component.store, 
			dock: 'bottom',
			displayInfo: true,
			displayMsg: 'Displaying records {0} - {1} of {2}',
			emptyMsg: "No topics to display",
			listeners:{
				'beforechange': 
				function(component,page,options){
					//node.set("name", node.get("name") + '(Displaying records {0} - {1} of {2})');
					while (node.hasChildNodes()) {
						node.removeChild(node.childNodes[0]);
					}
				}
			}

		} );

		myToolbar.store.proxy.extraParams = inputArray;

		component.addDocked(myToolbar);
	}

});